<!DOCTYPE html>
<html>
<head>
  <meta name='referrer' content='no-referrer'>
  <meta name='viewport' content='width=device-width,initial-scale=1.0' />
  <script src='https://cdnjs.cloudflare.com/ajax/libs/shaka-player/3.0.7/shaka-player.ui.min.js'></script>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/shaka-player/3.0.7/controls.min.css' />
  <style>
    body {
      background-color: black;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    
    .shaka-spinner-container, .shaka-current-time, .shaka-progress-container {
      display: none !important;
    }
    
    #videoContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    #liveIndicator {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(255, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: bold;
      z-index: 10;
      display: flex;
      align-items: center;
    }
    
    .liveDot {
      width: 8px;
      height: 8px;
      background-color: white;
      border-radius: 50%;
      margin-right: 5px;
      animation: pulse 1.5s infinite;
    }
    
    #loadingMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
      z-index: 5;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }
    
    .shaka-resolution-button {
      /* Ensure resolution selector is visible */
      display: inline-block !important;
    }
  </style>
</head>
<body>
  <div id="videoContainer" data-shaka-player-container>
    <video autoplay data-shaka-player id='video' style='width:100%;height:100%;'></video>
    <div id="liveIndicator">
      <div class="liveDot"></div>
      <span>LIVE</span>
    </div>
    <div id="loadingMessage">Loading stream...</div>
  </div>

  <script>
    var reloadtime = 10000; // Increased to 10 seconds for better user experience
    
    // Function to handle autoplay with user interaction
    function setupAutoplay() {
      const video = document.getElementById('video');
      
      // Try to play programmatically
      const playPromise = video.play();
      
      if (playPromise !== undefined) {
        playPromise.catch(error => {
          // Auto-play was prevented, show a play button
          console.log('Autoplay prevented, waiting for user interaction');
          document.addEventListener('click', function() {
            video.play().catch(e => console.log('Play after click failed:', e));
          }, { once: true });
        });
      }
    }
    
    async function init() {
      const video = document.getElementById('video');
      const ui = video.ui;
      const controls = ui.getControls();
      const player = controls.getPlayer();
      
      // Show loading message
      document.getElementById('loadingMessage').style.display = 'block';
      
      player.configure({
        drm: {
          servers: {
            'com.widevine.alpha': 'https://azy4sj9b.anycast.nagra.com/AZY4SJ9B/wvls/contentlicenseservice/v1/licenses'
          }
        },
        abr: {
          enabled: true,
          defaultBandwidthEstimate: 1000000, // Increased for better initial quality
          restrictions: {
            maxHeight: 240, // Start with low quality
            minHeight: 144
          }
        },
        streaming: {
          bufferingGoal: 30,
          rebufferingGoal: 2,
          bufferBehind: 30,
          lowLatencyMode: true, // Enable low latency for live streams
          accurateSeek: true,
          smallGapLimit: 0.5,
          jumpLargeGaps: true
        }
      });
      
      window.player = player;
      window.ui = ui;
      
      player.addEventListener('error', onPlayerErrorEvent);
      controls.addEventListener('error', onUIErrorEvent);
      
      player.getNetworkingEngine().registerRequestFilter(function(type, request) {
        if (type == shaka.net.NetworkingEngine.RequestType.LICENSE) {
          request.headers['User-Agent'] = 'ReactNativeVideo/3.0 (Linux;Android 11) ExoPlayerLib/2.10.4';
          request.headers['referer'] = 'app.azamtvmax.com';
          request.headers['origin'] = 'app.azamtvmax.com';
          request.headers['nv-tenant-id'] = 'AZY4SJ9B';
          request.headers['nv-authorizations'] = "eyJraWQiOiI3NzUwOTAiLCJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ2ZXIiOiIxLjAiLCJjb250ZW50UmlnaHRzIjpbeyJjb250ZW50SWQiOiJDSC0zOTc0YzJjZC05ZWM0LTRkMDMtODJiMS05Yzk5Mzk3M2U0ODciLCJzdGFydCI6IjIwMjUtMDMtMzFUMDA6MDA6MDBaIiwiZW5kIjoiMjAzMC0wMi0xOVQwMDowMDowMFoiLCJ1c2FnZVJ1bGVzUHJvZmlsZUlkIjoiU0QifV0sInRlbmFudElkIjoiQVpZNFNKOUIiLCJ0eXAiOiJDb250ZW50QXV0aFoiLCJleHAiOjE3NTk0Mjc5NzYsImRldmljZSI6eyJ3YXRlcm1hcmtpbmciOnRydWUsImFjY291bnRJZCI6Ijc3OTExMSJ9fQ.XSKj5b3dJxskzbzOmPdmbnFsZpWRVKOTWpFKPbdM_6Q";
        }
        if (type == shaka.net.NetworkingEngine.RequestType.MANIFEST) {
          request.headers['User-Agent'] = 'ReactNativeVideo/3.0 (Linux;Android 11) ExoPlayerLib/2.10.4';
          request.headers['referer'] = 'app.azamtvmax.com';
          request.headers['origin'] = 'app.azamtvmax.com';
        }
      });
      
      try {
        await player.load("https://cdnblncr.azamtvltd.co.tz/live/eds/AzamSport1/DASH/AzamSport1.mpd?cdntoken=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJleHAiOjE3NTczMDM5NzYsInNpcCI6IjE1LjE1OC4xMS40NCJ9.MPfAhezJ_31dA2Ql-Fsd5iwyevr4ACyqMrCOsx0kxnyRasiJPWqbMGVhf4MuLffVEdqFpGXLb_eRQgQa8Fu8Bg&hdnts=exp=1757303976~acl=/*~hmac=53d576cc82ac1b4b2fa880e46611da7230d65914b2ae96f7564e8a34412b141d");
        
        console.log('The video has now been loaded!');
        
        // Hide loading message
        document.getElementById('loadingMessage').style.display = 'none';
        
        // Setup autoplay
        setupAutoplay();
        
        // Enable resolution selection in UI
        ui.configure({
          controlPanelElements: ['play_pause', 'mute', 'volume', 'time_and_duration', 
                                'fullscreen', 'overflow_menu'],
          overflowMenuButtons: ['quality']
        });
        
        // Listen for player state changes
        player.addEventListener('buffering', (event) => {
          if (event.buffering) {
            console.log('Player is buffering');
          } else {
            console.log('Player finished buffering');
          }
        });
        
      } catch (error) {
        console.error('Error loading video:', error);
        document.getElementById('loadingMessage').textContent = 'Error loading stream. Retrying...';
        
        setTimeout(function() {
          location.reload();
        }, reloadtime);
      }
    }

    function onPlayerErrorEvent(errorEvent) {
      console.error('Player error event:', errorEvent);
      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('loadingMessage').textContent = 'Stream error. Retrying...';
      
      setTimeout(function() {
        location.reload();
      }, reloadtime);
    }

    function onPlayerError(error) {
      console.error('Player error:', error);
      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('loadingMessage').textContent = 'Player error. Retrying...';
      
      setTimeout(function() {
        location.reload();
      }, reloadtime);
    }

    function onUIErrorEvent(errorEvent) {
      console.error('UI error event:', errorEvent);
      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('loadingMessage').textContent = 'UI error. Retrying...';
      
      setTimeout(function() {
        location.reload();
      }, reloadtime);
    }

    function initFailed(errorEvent) {
      console.error('UI load failed:', errorEvent);
      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('loadingMessage').textContent = 'Player failed to load. Retrying...';
      
      setTimeout(function() {
        location.reload();
      }, reloadtime);
    }
    
    // Initialize when UI is loaded
    document.addEventListener('shaka-ui-loaded', init);
    document.addEventListener('shaka-ui-load-failed', initFailed);
  </script>
</body>
</html>